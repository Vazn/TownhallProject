var e=this&&this.__awaiter||function(e,t,i,s){function o(e){return e instanceof i?e:new i((function(t){t(e)}))}return new(i||(i=Promise))((function(i,n){function l(e){try{c(s.next(e))}catch(e){n(e)}}function a(e){try{c(s.throw(e))}catch(e){n(e)}}function c(e){e.done?i(e.value):o(e.value).then(l,a)}c((s=s.apply(e,t||[])).next())}))};import t from"express";import i from"multer";import{__dirname as s,getDate as o,formatTitles as n,log as l,error as a}from"./helpers.js";import{User as c,Article as r,Event as d}from"./models/index.js";const u=t.Router(),m=i.diskStorage({destination:(e,t,i)=>{const o=s+"/public/uploads";if(t.mimetype.includes("image")){i(null,o+"/images")}t.mimetype.includes("video")&&i(null,o+"/videos"),t.mimetype.includes("application")&&i(null,o+"/documents")},filename:(e,t,i)=>{i(null,`${o()+"-"+t.originalname}`)}}),g=i({storage:m});function f(e,t){return(i,s)=>{var o;let n=null!==(o=i.data)&&void 0!==o?o:null,l=!0;null!==n&&0!==n.length||(l=!1),s.render(`${e}`,{page:e,title:t,logged:i.session.authenticated,data:n,dataExist:l})}}function y(t,i){return(s,o,n)=>e(this,void 0,void 0,(function*(){const e=yield r.find({category:t}).limit(i).lean();for(let t of e)t.title=t.title.replace(/_/g," ");s.data=e,n()}))}function h(e,t,i){e.session.authenticated?(l("Authentication : OK"),i()):(a("Acces denied"),t.status(403).end())}u.get("/deleteArticle/:title",h,((t,i)=>e(void 0,void 0,void 0,(function*(){yield r.deleteOne({title:t.params.title}),i.json({success:!0})})))),u.post("/articleUpdate/:category",g.any(),h,((t,i)=>e(void 0,void 0,void 0,(function*(){const e=n(t.body.title),s=t.body.content,o=yield r.findOne({title:e}),l=[],a=[];let c;if(void 0!==t.files)for(let e=0;e<t.files.length;e++)"documents"===t.files[e].fieldname?a.push(t.files[e].filename):"images"===t.files[e].fieldname?l.push(t.files[e].filename):"thumbnail"===t.files[e].fieldname&&(console.log("req.files[i] : ",t.files[e]),c=t.files[e].filename);if(null===o)try{yield r.create({title:e,content:s,images:{empty:0===l.length,imagesPaths:l},documents:{empty:0===a.length,docPaths:a},thumbnail:c,category:t.params.category}),i.json({type:"Creation",success:!0})}catch(e){i.json({type:"Creation",success:!1})}else try{yield r.updateOne({title:e},{$set:{content:s,images:{empty:0===l.length,imagesPaths:l},documents:{empty:0===a.length,docPaths:a},thumbnail:c}}),i.json({type:"Modification",success:!0})}catch(e){i.json({type:"Modification",success:!1})}})))),u.post("/eventCreate",h,((t,i)=>e(void 0,void 0,void 0,(function*(){const{title:e,type:s,description:o,start:n,end:l}=t.body;try{yield d.create({title:e,type:s,description:o,start:n,end:l}),i.json({success:!0})}catch(e){console.log("e : ",e),i.json({success:!1})}})))),u.post("/registerUser",((t,i)=>e(void 0,void 0,void 0,(function*(){try{const e=yield c.create({email:t.body.email,password:t.body.password});i.json(e)}catch(e){i.json({message:e})}})))),u.post("/login",((t,i)=>e(void 0,void 0,void 0,(function*(){const e=t.body.email.trim(),s=t.body.password.trim();if(""!==e&&""!==s)if(t.session.authenticated)i.json({success:!1});else{const o=yield c.findOne({email:e});null!==o&&o.password===s?(t.session.authenticated=!0,t.session.save(),i.status(301).json({success:!0})):i.status(403).json({success:!1})}else a("Form data are missing or empty !"),i.status(400).json({success:!1})})))),u.get("/logout",((e,t)=>{e.session.destroy((()=>{t.redirect("/")}))})),u.get("/getEvents",((t,i)=>e(void 0,void 0,void 0,(function*(){const e=yield d.find({}).lean();i.json(e)})))),u.get("^/$|/index(.html)?",y("actualites",8),f("index","Commune de Rouffiac d'Aude")),u.get("/actualites(.html)?",y("actualites",0),f("actualites","Actualités")),u.get("/calendrier(.html)?",f("calendrier","Agenda et activités")),u.get("/ecole(.html)?",y("ecole",0),f("articlesLayout","Ecole")),u.get("/associations(.html)?",f("articlesLayout","Associations")),u.get("/mediatheque(.html)?",f("articlesLayout","Médiatheque")),u.get("/transport(.html)?",f("articlesLayout","Transports")),u.get("/entreprises(.html)?",f("articlesLayout","Entreprises")),u.get("/urbanisme(.html)?",f("articlesLayout","Urbanisme")),u.get("/etatCivil(.html)?",f("articlesLayout","Etat Civil")),u.get("/scolarite(.html)?",f("articlesLayout","Scolarité")),u.get("/risques(.html)?",f("articlesLayout","Risques")),u.get("/leVillage(.html)?",f("articlesLayout","Le village")),u.get("/lesElus(.html)?",f("articlesLayout","Les Elus")),u.get("/lesCommissions(.html)?",f("articlesLayout","Les Commissions")),u.get("/login(.html)?",f("login","Connexion")),u.get("/legal(.html)?",f("legal","Mentions légales"));export{u as router};